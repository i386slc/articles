# Как остановить поток в Python

{% hint style="info" %}
Ссылка на оригинальную статью: [How to Sleep a Thread in Python](https://superfastpython.com/thread-sleep-in-python/)

Опубликовано: 1 апреля 2022

Последнее обновление: 12 сентября 2022

Авторы:  [Jason Brownlee](https://superfastpython.com/about)
{% endhint %}

Вы можете перевести поток в режим сна, вызвав функцию time.sleep().

В этом уроке вы узнаете, как перевести поток в режим сна в Python.

Давайте начнем.

## Оглавление

1. [Необходимость остановки потока](kak-ostanovit-potok-v-python.md#id-1.-neobkhodimost-ostanovki-potoka)
2. [Что такое сон](kak-ostanovit-potok-v-python.md#id-2.-chto-takoe-son)
3. [Зачем использовать сон](kak-ostanovit-potok-v-python.md#id-3.-zachem-ispolzovat-son)
   1. [Спать, чтобы ввести задержку](kak-ostanovit-potok-v-python.md#id-3.1.-spat-chtoby-vvesti-zaderzhku)
   2. [Спать, чтобы замедлить цикл](kak-ostanovit-potok-v-python.md#id-3.2.-spat-chtoby-zamedlit-cikl)
   3. [Спите, чтобы позволить другим потокам работать](kak-ostanovit-potok-v-python.md#id-3.3.-spite-chtoby-pozvolit-drugim-potokam-rabotat)
   4. [Спящий режим для отладки](kak-ostanovit-potok-v-python.md#id-3.4.-spyashii-rezhim-dlya-otladki)
4. [Как спать в потоке](kak-ostanovit-potok-v-python.md#id-4.-kak-spat-v-potoke)
   1. [Как заснуть на миллисекунды](kak-ostanovit-potok-v-python.md#id-4.1.-kak-zasnut-na-millisekundy)
   2. [Как заснуть на несколько секунд](kak-ostanovit-potok-v-python.md#id-4.2.-kak-zasnut-na-neskolko-sekund)
   3. [Как заснуть на несколько минут](kak-ostanovit-potok-v-python.md#id-4.3.-kak-zasnut-na-neskolko-minut)
   4. [Как спать часами](kak-ostanovit-potok-v-python.md#id-4.4.-kak-spat-chasami)
   5. [Как спать целыми днями](kak-ostanovit-potok-v-python.md#id-4.5.-kak-spat-celymi-dnyami)
5. [Советы при использовании режима сна](kak-ostanovit-potok-v-python.md#id-5.-sovety-pri-ispolzovanii-rezhima-sna)
   1. [Сон не снимает блокировки](kak-ostanovit-potok-v-python.md#id-5.1.-son-ne-snimaet-blokirovki)
   2. [Используйте сон, когда заняты ожиданием](kak-ostanovit-potok-v-python.md#id-5.2.-ispolzuite-son-kogda-zanyaty-ozhidaniem)
   3. [Спать ноль секунд](kak-ostanovit-potok-v-python.md#id-5.3.-spat-nol-sekund)
   4. [Рассмотрите возможность ожидания вместо сна](kak-ostanovit-potok-v-python.md#id-5.4.-rassmotrite-vozmozhnost-ozhidaniya-vmesto-sna)
   5. [Защита от сигналов терминала](kak-ostanovit-potok-v-python.md#id-5.5.-zashita-ot-signalov-terminala)
6. [Дальнейшее чтение](kak-ostanovit-potok-v-python.md#id-6.-dalneishee-chtenie)
7. [Заключение](kak-ostanovit-potok-v-python.md#id-7.-vynos)

## 1. Необходимость остановки потока

Поток — это [поток выполнения](https://en.wikipedia.org/wiki/Thread\_\(computing\)) компьютерной программы.

Каждая программа Python имеет по крайней мере один поток выполнения, называемый основным потоком. И процессы, и потоки создаются и управляются базовой операционной системой.

Иногда нам может потребоваться создать дополнительные потоки в нашей программе для одновременного выполнения кода.

Python предоставляет возможность создавать новые потоки и управлять ими с помощью модуля threading и [класса threading.Thread](https://docs.python.org/3/library/threading.html).

Вы можете узнать больше о потоках Python в руководстве:

* [Потоки в Python: полное руководство](https://superfastpython.com/threading-in-python/)

В конкурентном программировании мы можем захотеть, чтобы текущий поток заблокировался или приостановился на определенное время.

Как мы можем заставить потоки спать в Python?

Выполняйте циклы, используя все процессоры. [Загрузите БЕСПЛАТНУЮ книгу](https://superfastpython.com/plip-incontent), чтобы узнать, как это сделать.

## 2. Что такое сон

[Функция time.sleep()](https://docs.python.org/3/library/time.html#time.sleep) заставит вызывающий поток заблокироваться на указанное количество секунд.

> Приостановить выполнение вызывающего потока на заданное количество секунд.
>
> _—_ [_time — Time access and conversions_](https://docs.python.org/3/library/time.html)

Например:

```python
...
# приостановить на 5 секунд
time.sleep(5)
```

Функция time.sleep() требует времени в секундах с плавающей запятой.

Если указана дробь меньше нуля, это указывает количество миллисекунд, на которое вызывающий поток должен заблокироваться.

> Аргументом может быть число с плавающей запятой, указывающее более точное время сна.
>
> _—_ [_time — Time access and conversions_](https://docs.python.org/3/library/time.html)

Напомним, что в одной секунде 1000 миллисекунд. Следовательно, значение сна 0,1 позволит вызывающему потоку приостановиться на 1/10 секунды или 100 миллисекунд.

```python
...
# приостановить на 100 миллисекунд
time.sleep(0.1)
```

Мы можем вызвать функцию time.sleep() из основного потока, который является потоком по умолчанию в вашем процессе. Мы также можем вызвать функцию time.sleep() из нового потока, используемого для выполнения пользовательской функции.

Вызывающий поток может заблокироваться на время, меньшее, чем указанное, если процесс прерван.

> Фактическое время приостановки может быть меньше запрошенного, поскольку любой пойманный сигнал завершит работу sleep() после выполнения процедуры перехвата этого сигнала.
>
> _—_ [_time — Time access and conversions_](https://docs.python.org/3/library/time.html)

Это может произойти, если пользователь нажмет Ctrl-C, чтобы отправить [SIGINT](https://en.wikipedia.org/wiki/Signal\_\(IPC\)#SIGINT) (прерывание сигнала) процессу, владеющему потоком, который по умолчанию завершит процесс.

Вызывающий поток будет заблокирован как минимум на указанное количество секунд, но может блокироваться и дольше.

> … время приостановки может быть дольше, чем запрошено на произвольную величину, из-за планирования другой активности в системе.
>
> _—_ [_time — Time access and conversions_](https://docs.python.org/3/library/time.html)

Это связано с тем, что базовая операционная система решает, какие потоки следует запускать и когда их запускать. Он может решить заблокировать поток на некоторое время, прежде чем разбудить его и разрешить возобновить выполнение (например, на долю секунды дольше).

Функция time.sleep() вызывает системную функцию, чтобы заблокировать вызывающий поток, например, [системный вызов сна](https://en.wikipedia.org/wiki/Sleep\_\(system\_call\)). Сам вызов этой функции может иметь большую или меньшую точность, чем вам требуется. Например, хотя вы указываете время ожидания в одну или несколько миллисекунд, базовый системный вызов может иметь точность, ограниченную десятками миллисекунд.

Это возможность, предоставляемая базовой операционной системой, и она может быть реализована по-разному в разных операционных системах, таких как Windows, Linux и MacOS.

Далее давайте рассмотрим, почему мы можем приостановить поток.

## 3. Зачем использовать сон

Есть много причин, по которым мы можем захотеть, чтобы поток заснул.

Например:

1. Добавьте задержку.
2. Замедлить выполнение цикла.
3. Разрешить запуск других потоков.
4. Принудительное состояние гонки во время отладки.

Давайте подробнее рассмотрим каждый по очереди.

### 3.1. Спать, чтобы ввести задержку

Возможно, мы захотим ввести задержку в нашу программу.

Это может быть сделано для того, чтобы избежать перегрузки внешнего ресурса, например:

* Создание слишком большого количества подключений к веб-серверу
* слишком быстрое создание слишком большого количества файлов.
* Отправка большого количества писем слишком быстро.

Например, слишком много быстрых последовательных операций с внешним ресурсом могут привести к срабатыванию мер компьютерной безопасности для защиты ресурса от атаки типа «отказ в обслуживании».

Это может быть просто замедление процесса, чтобы позволить пользователю или другому потоку заметить и отреагировать на изменения внутри приложения.

### 3.2. Спать, чтобы замедлить цикл

Мы можем ввести спящий режим, чтобы замедлить выполнение цикла.

Это может быть сделано для того, чтобы сделать программу более удобной для использования, например, чтобы позволить пользователю видеть и читать сообщения, выводимые на каждой итерации.

Это также может быть сделано для того, чтобы избежать перегрузки внешнего ресурса, который используется на каждой итерации цикла.

### 3.3. Спите, чтобы позволить другим потокам работать

Вызов сна заблокирует текущий поток.

Это сигнализирует базовой операционной системе, что поток является кандидатом на переключение контекста.

Возможно, вы помните, что современные операционные системы, такие как Windows, MacOS и Linux, обеспечивают многозадачность посредством [потоков переключения контекста](https://en.wikipedia.org/wiki/Context\_switch). Здесь выполняемые потоки приостанавливаются, а приостановленные потоки возобновляются. Этот процесс переключения контекста между потоками постоянно происходит в операционной системе для имитации одновременного запуска нескольких программ и программных потоков.

Вызов сна — это один из способов разрешить запуск других потоков в приложении Python или других потоков в системе.

Этого можно добиться с помощью вызова time.sleep() с нулевым значением секунд, например:

```python
...
# позволяет другим потокам запуститься
time.sleep(0)
```

### 3.4. Спящий режим для отладки

Добавление режима ожидания в программу может помочь выявить ошибки.

Условия гонки могут возникнуть, если два потока пытаются одновременно прочитать или изменить незащищенные переменные или скоординировать действия с ожиданием/уведомлением.

Часто условия гонки не обнаруживаются до тех пор, пока в программе не возникнет неожиданная задержка, например, когда ресурс занимает необычно много времени.

Мы можем провести стресс-тестирование наших параллельных приложений и выявить условия гонки, добавив в код режимы ожидания во время тестирования.

Например, если один поток ожидает уведомления о threading.Condition другого потока, а другой поток вызывает notify() до того, как ожидающий поток вызывает wait(), то это указывает на состояние гонки, и ожидающий поток никогда не будет уведомлен.

Возможно, мы сможем вызвать это состояние гонки, добавив вызов time.sleep() перед вызовом ожидающего потока wait(), чтобы имитировать естественную задержку переключения контекста и посмотреть, работает ли механизм ожидания-уведомления, используемый в программе, правильно.

Вы можете узнать больше об этом типе состояния гонки в этом уроке:

* [Как исправить состояние гонки с помощью синхронизации в Python](https://superfastpython.com/thread-race-condition-timing/)

Далее давайте подробнее рассмотрим, как спать.

## 4. Как спать в потоке

Мы можем перевести поток в режим сна, вызвав из потока функцию time.sleep().

Например:

```python
...
# заблокировать текущий поток на 10 секунд
time.sleep(10)
```

Функция сна принимает значение с плавающей запятой для количества секунд сна, где доли секунды — это миллисекунды.

Например:

```python
...
# заблокировать текущий поток на 10 миллисекунд
time.sleep(0.010)
```

Мы можем спать в течение более длительных интервалов, таких как минуты и дни, указав эти интервалы в количестве секунд.

Давайте проясним это на нескольких примерах.

Примечание. Возможно, вы помните, что хотя мы указываем количество секунд для сна, программа может спать дольше, поскольку возобновление потока зависит от прихоти и возможностей базовой операционной системы.

### 4.1. Как заснуть на миллисекунды

В одной секунде 1000 миллисекунд.

Мы можем указать временной интервал в виде доли секунды с плавающей запятой, чтобы спать в течение миллисекунд.

Например:

* 1000 миллисекунд — это 1 секунда.
* 100 миллисекунд — это 0,1 секунды.
* 10 миллисекунд — это 0,01 секунды.
* 1 миллисекунда равна 0,001 секунды.

В примере ниже показано, как спать на полсекунды или 500 миллисекунд.

```python
# SuperFastPython.com
# пример сна на несколько миллисекунд
from time import sleep
# вывод сообщения
print('Sleeping for half a second')
# блокировка
sleep(0.5)
```

Мы можем обновить программу, чтобы она запускалась один раз каждые 500 миллисекунд или два раза в секунду, вызывая сон в цикле.

Например:

```python
# SuperFastPython.com
# пример запуска дважды за минуту
from time import sleep
# запустить навсегда
while True:
    # делаем задачу
    # ...
    # вывод сообщения
    print('Sleeping for half a second')
    # блокировка
    sleep(0.5)
```

### 4.2. Как заснуть на несколько секунд

Функция time.sleep() требует количество секунд для сна непосредственно в качестве аргумента.

Например, мы можем спать 30 секунд, указав в функции значение 30.

```python
# SuperFastPython.com
# пример сна на несколько секунд
from time import sleep
# вывод сообщения
print('Sleeping for 30 seconds')
# блокировка
sleep(30)
```

Мы можем обновить программу, чтобы она запускалась один раз каждые 30 секунд или два раза в минуту, вызывая сон в цикле.

Например:

```python
# SuperFastPython.com
# пример запуска дважды за минуту
from time import sleep
# запустить навсегда
while True:
    # делаем задачу
    # ...
    # вывод сообщения
    print('Sleeping for 30 seconds')
    # блокировка
    sleep(30)
```

### 4.3. Как заснуть на несколько минут

Мы можем спать заданное количество минут, указав интервал в секундах.

Например:

* 1 минута это 60 секунд.
* 10 минут это 600 секунд.
* 100 минут — это 6000 секунд.

Возможно, будет проще указать интервал как умножение, например 2 минуты и 30 секунд можно указать как `2,5 * (60)`, что составляет 150 секунд.

В приведенном ниже примере показано, как спать в течение 5 минут, заданных как умножение.

```python
# SuperFastPython.com
# пример сна на несколько минут
from time import sleep
# вывод сообщения
print('Sleeping for 5 minutes')
# блокировка
sleep(5 * 60)
```

Мы можем обновить программу, чтобы она запускалась каждые 5 минут или 12 раз в час, вызывая сон в цикле.

Например:

```python
# SuperFastPython.com
# пример запуска двенадцать раз в час
from time import sleep
# запустить навсегда
while True:
    # делаем задачу
    # ...
    # вывод сообщения
    print('Sleeping for 5 minutes')
    # блокировка
    sleep(5 * 60)
```

### 4.4. Как спать часами

### 4.5. Как спать целыми днями

## 5. Советы при использовании режима сна

### 5.1. Сон не снимает блокировки

### 5.2. Используйте сон, когда заняты ожиданием

### 5.3. Спать ноль секунд

### 5.4. Рассмотрите возможность ожидания вместо сна

### 5.5. Защита от сигналов терминала

## 6. Дальнейшее чтение

## 7. Заключение
